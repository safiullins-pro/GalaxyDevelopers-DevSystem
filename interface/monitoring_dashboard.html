<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaxy Monitoring Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .status {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.active {
            background: #10b981;
        }
        
        .status-indicator.warning {
            background: #f59e0b;
        }
        
        .status-indicator.error {
            background: #ef4444;
        }
        
        .status-indicator.idle {
            background: #6b7280;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .metric-label {
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        .metric-value {
            font-weight: bold;
            color: #333;
        }
        
        .file-changes {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .file-change {
            padding: 8px;
            margin: 5px 0;
            background: #f3f4f6;
            border-radius: 5px;
            font-size: 0.85rem;
        }
        
        .file-change.created {
            border-left: 3px solid #10b981;
        }
        
        .file-change.modified {
            border-left: 3px solid #3b82f6;
        }
        
        .file-change.deleted {
            border-left: 3px solid #ef4444;
        }
        
        .compliance-bar {
            position: relative;
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .compliance-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .check-item {
            display: flex;
            align-items: center;
            padding: 5px 0;
        }
        
        .check-icon {
            margin-right: 8px;
        }
        
        #connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
        }
        
        .websocket-log {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            background: #764ba2;
        }
    </style>
</head>
<body>
    <div id="connection-status">
        <span class="status-indicator idle" id="ws-indicator"></span>
        <span id="ws-status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
    </div>
    
    <div class="container">
        <h1>üåå Galaxy Monitoring Dashboard</h1>
        
        <div class="dashboard">
            <!-- WebSocket Status -->
            <div class="card">
                <h2>üîå WebSocket Status</h2>
                <div class="status">
                    <span class="status-indicator idle" id="websocket-status"></span>
                    <span id="websocket-text">–û—Ç–∫–ª—é—á–µ–Ω</span>
                </div>
                <div class="websocket-log" id="ws-log">
                    > –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...<br>
                </div>
                <button class="btn" onclick="connectWebSocket()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
                <button class="btn" onclick="testWebSocket()">–¢–µ—Å—Ç</button>
            </div>
            
            <!-- System Status -->
            <div class="card">
                <h2>üìä –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h2>
                <div class="metric">
                    <span class="metric-label">File Observer</span>
                    <span class="metric-value" id="file-observer">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ –ø—É—Ç–∏</span>
                    <span class="metric-value" id="watched-paths">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">WebSocket –∫–ª–∏–µ–Ω—Ç—ã</span>
                    <span class="metric-value" id="ws-clients">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</span>
                    <span class="metric-value" id="recent-changes">-</span>
                </div>
                <button class="btn" onclick="updateSystemStatus()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
            
            <!-- File Changes -->
            <div class="card">
                <h2>üìÅ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤</h2>
                <div class="file-changes" id="file-changes">
                    <div class="file-change idle">–û–∂–∏–¥–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π...</div>
                </div>
                <button class="btn" onclick="fetchFileChanges()">–û–±–Ω–æ–≤–∏—Ç—å</button>
                <button class="btn" onclick="clearFileChanges()">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
            
            <!-- Security Scan -->
            <div class="card">
                <h2>üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h2>
                <div class="metric">
                    <span class="metric-label">–°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏</span>
                    <span class="metric-value" id="syntax-errors">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">–£—è–∑–≤–∏–º–æ—Å—Ç–∏</span>
                    <span class="metric-value" id="vulnerabilities">-</span>
                </div>
                <div id="security-details"></div>
                <button class="btn" onclick="runSecurityScan()">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn" onclick="runSyntaxCheck()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å</button>
            </div>
            
            <!-- Compliance -->
            <div class="card">
                <h2>‚úÖ Compliance</h2>
                <div id="compliance-checks">
                    <div class="metric">
                        <span class="metric-label">ISO 27001</span>
                        <div class="compliance-bar">
                            <div class="compliance-fill" id="iso27001-bar" style="width: 0%">0%</div>
                        </div>
                    </div>
                    <div class="metric">
                        <span class="metric-label">ITIL 4</span>
                        <div class="compliance-bar">
                            <div class="compliance-fill" id="itil4-bar" style="width: 0%">0%</div>
                        </div>
                    </div>
                    <div class="metric">
                        <span class="metric-label">COBIT</span>
                        <div class="compliance-bar">
                            <div class="compliance-fill" id="cobit-bar" style="width: 0%">0%</div>
                        </div>
                    </div>
                </div>
                <button class="btn" onclick="checkCompliance()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
            </div>
            
            <!-- Integration Tests -->
            <div class="card">
                <h2>üß™ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã</h2>
                <div id="test-results">
                    <div class="metric">
                        <span class="metric-label">–ü—Ä–æ–π–¥–µ–Ω–æ</span>
                        <span class="metric-value" id="tests-passed">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">–ü—Ä–æ–≤–∞–ª–µ–Ω–æ</span>
                        <span class="metric-value" id="tests-failed">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Success Rate</span>
                        <span class="metric-value" id="success-rate">-</span>
                    </div>
                </div>
                <button class="btn" onclick="runIntegrationTests()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã</button>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:8766';
        const WS_URL = 'ws://localhost:8765/monitoring';
        let websocket = null;
        
        // WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        function connectWebSocket() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                console.log('WebSocket —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
                return;
            }
            
            websocket = new WebSocket(WS_URL);
            
            websocket.onopen = () => {
                console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                updateWSStatus('active', '–ü–æ–¥–∫–ª—é—á–µ–Ω');
                addWSLog('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ —Å–µ—Ä–≤–µ—Ä—É');
            };
            
            websocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('WebSocket —Å–æ–æ–±—â–µ–Ω–∏–µ:', data);
                handleWebSocketMessage(data);
            };
            
            websocket.onerror = (error) => {
                console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
                updateWSStatus('error', '–û—à–∏–±–∫–∞');
                addWSLog('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            };
            
            websocket.onclose = () => {
                console.log('WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
                updateWSStatus('idle', '–û—Ç–∫–ª—é—á–µ–Ω');
                addWSLog('üîå –û—Ç–∫–ª—é—á–µ–Ω –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
            };
        }
        
        function testWebSocket() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({ type: 'ping' }));
                addWSLog('‚Üí –û—Ç–ø—Ä–∞–≤–ª–µ–Ω ping');
            } else {
                alert('WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
            }
        }
        
        function handleWebSocketMessage(data) {
            addWSLog(`‚Üê ${data.type}: ${JSON.stringify(data).substring(0, 100)}`);
            
            switch(data.type) {
                case 'file_change':
                    addFileChange(data.change);
                    break;
                case 'system_status':
                    updateSystemStatusDisplay(data);
                    break;
                case 'pong':
                    addWSLog('‚úì –ü–æ–ª—É—á–µ–Ω pong');
                    break;
            }
        }
        
        function updateWSStatus(status, text) {
            const indicator = document.getElementById('ws-indicator');
            const statusText = document.getElementById('ws-status');
            const wsIndicator = document.getElementById('websocket-status');
            const wsText = document.getElementById('websocket-text');
            
            indicator.className = `status-indicator ${status}`;
            statusText.textContent = text;
            wsIndicator.className = `status-indicator ${status}`;
            wsText.textContent = text;
        }
        
        function addWSLog(message) {
            const log = document.getElementById('ws-log');
            log.innerHTML += `> ${new Date().toLocaleTimeString()}: ${message}<br>`;
            log.scrollTop = log.scrollHeight;
        }
        
        // System Status
        async function updateSystemStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/monitoring/status`);
                const data = await response.json();
                updateSystemStatusDisplay(data);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
            }
        }
        
        function updateSystemStatusDisplay(data) {
            document.getElementById('file-observer').textContent = 
                data.file_observer_active ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : '‚ùå –ù–µ–∞–∫—Ç–∏–≤–µ–Ω';
            document.getElementById('watched-paths').textContent = 
                data.watched_paths ? data.watched_paths.length : '0';
            document.getElementById('ws-clients').textContent = 
                data.websocket_clients || '0';
            document.getElementById('recent-changes').textContent = 
                data.recent_changes || '0';
        }
        
        // File Changes
        async function fetchFileChanges() {
            try {
                const response = await fetch(`${API_BASE}/api/monitoring/file-changes`);
                const changes = await response.json();
                
                const container = document.getElementById('file-changes');
                if (changes.length === 0) {
                    container.innerHTML = '<div class="file-change idle">–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π</div>';
                } else {
                    container.innerHTML = '';
                    changes.forEach(change => addFileChange(change));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:', error);
            }
        }
        
        function addFileChange(change) {
            const container = document.getElementById('file-changes');
            const div = document.createElement('div');
            div.className = `file-change ${change.type}`;
            
            const fileName = change.path.split('/').pop();
            const time = new Date(change.timestamp).toLocaleTimeString();
            
            div.innerHTML = `
                <strong>${change.type}:</strong> ${fileName}
                <span style="float: right; color: #6b7280;">${time}</span>
            `;
            
            container.insertBefore(div, container.firstChild);
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
            while (container.children.length > 10) {
                container.removeChild(container.lastChild);
            }
        }
        
        function clearFileChanges() {
            document.getElementById('file-changes').innerHTML = 
                '<div class="file-change idle">–û—á–∏—â–µ–Ω–æ</div>';
        }
        
        // Security
        async function runSecurityScan() {
            try {
                const response = await fetch(`${API_BASE}/api/monitoring/security-scan`);
                const data = await response.json();
                
                document.getElementById('vulnerabilities').textContent = 
                    data.total || '0';
                
                const details = document.getElementById('security-details');
                if (data.vulnerabilities && data.vulnerabilities.length > 0) {
                    details.innerHTML = '<h4>–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:</h4>';
                    data.vulnerabilities.slice(0, 3).forEach(vuln => {
                        details.innerHTML += `
                            <div class="check-item">
                                <span class="check-icon">‚ö†Ô∏è</span>
                                <span>${vuln.message} (${vuln.severity})</span>
                            </div>
                        `;
                    });
                } else {
                    details.innerHTML = '<div class="check-item"><span class="check-icon">‚úÖ</span>–£—è–∑–≤–∏–º–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
            }
        }
        
        async function runSyntaxCheck() {
            try {
                const response = await fetch(`${API_BASE}/api/monitoring/syntax-check`);
                const data = await response.json();
                
                document.getElementById('syntax-errors').textContent = 
                    data.total || '0';
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞:', error);
            }
        }
        
        // Compliance
        async function checkCompliance() {
            const standards = ['ISO27001', 'ITIL4', 'COBIT'];
            
            for (const standard of standards) {
                try {
                    const response = await fetch(`${API_BASE}/api/monitoring/compliance/${standard}`);
                    const data = await response.json();
                    
                    const barId = `${standard.toLowerCase()}-bar`;
                    const bar = document.getElementById(barId);
                    if (bar) {
                        bar.style.width = `${data.score}%`;
                        bar.textContent = `${Math.round(data.score)}%`;
                    }
                } catch (error) {
                    console.error(`–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ ${standard}:`, error);
                }
            }
        }
        
        // Integration Tests
        async function runIntegrationTests() {
            try {
                const response = await fetch(`${API_BASE}/api/monitoring/integration-test`);
                const data = await response.json();
                
                document.getElementById('tests-passed').textContent = data.passed || '0';
                document.getElementById('tests-failed').textContent = data.failed || '0';
                document.getElementById('success-rate').textContent = 
                    data.success_rate ? `${Math.round(data.success_rate)}%` : '-';
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–æ–≤:', error);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onload = () => {
            connectWebSocket();
            updateSystemStatus();
            checkCompliance();
            
            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            setInterval(() => {
                updateSystemStatus();
            }, 5000);
        };
    </script>
</body>
</html>